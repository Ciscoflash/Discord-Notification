name: Notify Discord on Documentation Updates and Releases

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'docs/**'
      - 'blog/**'
      - '*.md'
      - 'docusaurus.config.ts'
      - 'sidebars.ts'
  release:
    types: [published]

jobs:
  notify-docs:
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          cd discord-bot
          npm install

      - name: Get changed files
        id: changed-files
        run: |
          echo "files=$(git diff --name-only HEAD~1 HEAD | grep -E '\.(md|mdx)$|docusaurus\.config\.ts|sidebars\.ts' | tr '\n' ',' | sed 's/,$//')" >> $GITHUB_OUTPUT

      - name: Set docs URL
        id: docs-url
        run: |
          # Try to get URL from environment or construct from repo
          if [ -n "${{ secrets.DOCS_URL }}" ]; then
            echo "url=${{ secrets.DOCS_URL }}" >> $GITHUB_OUTPUT
          else
            # Construct from GitHub Pages if using default setup
            echo "url=https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}" >> $GITHUB_OUTPUT
          fi

      - name: Send Discord notification
        if: steps.changed-files.outputs.files != ''
        env:
          DISCORD_TOKEN: ${{ secrets.DISCORD_TOKEN }}
          DISCORD_CHANNEL_ID: ${{ secrets.DISCORD_CHANNEL_ID }}
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
          GITHUB_COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
          CHANGED_FILES: ${{ steps.changed-files.outputs.files }}
          GITHUB_COMMIT_URL: https://github.com/${{ github.repository }}/commit/${{ github.sha }}
          DOCS_URL: ${{ steps.docs-url.outputs.url }}
        run: |
          cd discord-bot
          node send-notification.js

  notify-release:
    runs-on: ubuntu-latest
    if: github.event_name == 'release'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          cd discord-bot
          npm install

      - name: Set docs URL
        id: docs-url
        run: |
          if [ -n "${{ secrets.DOCS_URL }}" ]; then
            echo "url=${{ secrets.DOCS_URL }}" >> $GITHUB_OUTPUT
          else
            echo "url=https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}" >> $GITHUB_OUTPUT
          fi

      - name: Send Discord notification
        env:
          DISCORD_TOKEN: ${{ secrets.DISCORD_TOKEN }}
          DISCORD_CHANNEL_ID: ${{ secrets.DISCORD_CHANNEL_ID }}
          GITHUB_EVENT_NAME: release
          RELEASE_TAG: ${{ github.event.release.tag_name }}
          RELEASE_NAME: ${{ github.event.release.name }}
          RELEASE_BODY: ${{ github.event.release.body }}
          RELEASE_URL: ${{ github.event.release.html_url }}
          DOCS_URL: ${{ steps.docs-url.outputs.url }}
        run: |
          cd discord-bot
          node send-notification.js
